# Pipeline from bench1.yaml that resembles the most complex pipeline used
# in distsys to our knowledge.
id: main
interface:
  inputs: [ in ]
  outputs: [ out, error ]
nodes:
  - id: parse
    op: msgpack::decode
  - id: classify
    op: runtime::tremor
    config:
      script: |
        export class, dimension, rate, index_type;

        _ { $index_type := index; }

        application="app1" { $class := "applog_app1"; $rate := 1250; }
        application="app2" { $class := "applog_app2"; $rate := 2500; }
        application="app3" { $class := "applog_app3"; $rate := 18750; }
        application="app4" { $class := "applog_app4"; $rate := 750;   }
        application="app5" { $class := "applog_app5"; $rate := 18750; }
        $class { $dimension := application; return; }

        index_type="applog_app6" { $dimension := logger_name; $class := "applog_app6"; $rate := 4500; return; }

        index_type="syslog_app1" { $class := "syslog_app1"; $rate := 2500; }
        tags:"tag1" { $class := "syslog_app2"; $rate := 125; }
        index_type="syslog_app3" { $class := "syslog_app3"; $rate := 1750; }
        index_type="syslog_app4" { $class := "syslog_app4"; $rate := 1750; }
        index_type="syslog_app5" { $class := "syslog_app5"; $rate := 7500; }
        index_type="syslog_app6" { $class := "syslog_app6"; $rate := 125; }
        $class { $dimension := syslog_hostname; return; }

        _ { $class := "default"; $rate := 250; }
  - id: render
    op: msgpack::encode
  - id: group
    op: grouper::bucket
links:
  in: [ parse ]
  parse: [ classify ]
  classify: [ render ]
  render: [ group ]
  group: [ out ]
  group/error: [ error ]
